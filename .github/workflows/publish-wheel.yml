name: Build & publish slimgest wheel

on:
  push:
    branches:
      - main
  schedule:
    # Nightly (UTC)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      publish_to:
        description: "Where to publish the built wheel"
        type: choice
        options:
          - testpypi
          - pypi
        default: testpypi
        required: true
      version:
        description: "Version to publish (required when publishing to PyPI)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: publish-wheel-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Compute build version and metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          DATE_UTC="$(date -u +%Y%m%d)"
          TS_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          SHA_SHORT="$(git rev-parse --short HEAD)"

          # Best-effort branch name for metadata; ref_name works for schedule/dispatch/push.
          BRANCH="${GITHUB_REF_NAME:-unknown}"
          REF="${GITHUB_REF:-unknown}"

          # Sanitize for PEP 440 local version label (only [A-Za-z0-9._-]).
          SAN_BRANCH="$(echo "$BRANCH" | tr '/@' '..' | tr -cd 'A-Za-z0-9._-' | tr '[:upper:]' '[:lower:]')"
          if [[ -z "$SAN_BRANCH" ]]; then
            SAN_BRANCH="unknown"
          fi

          BASE_VERSION="$(python - <<'PY'
          import tomllib
          from pathlib import Path
          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          print(data["project"]["version"])
          PY
          )"

          EVENT="${GITHUB_EVENT_NAME}"
          PUBLISH_TO_INPUT="${{ inputs.publish_to }}"
          VERSION_INPUT="${{ inputs.version }}"

          if [[ "$EVENT" == "schedule" || "$EVENT" == "push" ]]; then
            PUBLISH_TO="testpypi"
            BUILD_VERSION="${BASE_VERSION}.dev${DATE_UTC}+${SAN_BRANCH}.${SHA_SHORT}"
          else
            PUBLISH_TO="$PUBLISH_TO_INPUT"
            if [[ "$PUBLISH_TO" == "pypi" ]]; then
              if [[ -z "${VERSION_INPUT}" ]]; then
                echo "ERROR: inputs.version is required when publishing to PyPI." >&2
                exit 2
              fi
              BUILD_VERSION="${VERSION_INPUT}"
            else
              # Manual TestPyPI run: allow explicit version, otherwise use nightly-style version.
              if [[ -n "${VERSION_INPUT}" ]]; then
                BUILD_VERSION="${VERSION_INPUT}"
              else
                BUILD_VERSION="${BASE_VERSION}.dev${DATE_UTC}+${SAN_BRANCH}.${SHA_SHORT}"
              fi
            fi
          fi

          echo "publish_to=${PUBLISH_TO}" >> "$GITHUB_OUTPUT"
          echo "build_version=${BUILD_VERSION}" >> "$GITHUB_OUTPUT"
          echo "date_utc=${DATE_UTC}" >> "$GITHUB_OUTPUT"
          echo "timestamp_utc=${TS_UTC}" >> "$GITHUB_OUTPUT"
          echo "sha_short=${SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "ref=${REF}" >> "$GITHUB_OUTPUT"

      - name: Set project version in pyproject.toml
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import re
          from pathlib import Path
          new_version = "${{ steps.meta.outputs.build_version }}"
          p = Path("pyproject.toml")
          lines = p.read_text(encoding="utf-8").splitlines(True)
          out = []
          in_project = False
          replaced = False
          for line in lines:
            nl = "\n" if line.endswith("\n") else ""
            line_wo_nl = line[:-1] if nl else line
            if re.match(r"^\s*\[project\]\s*$", line):
              in_project = True
            elif in_project and re.match(r"^\s*\[.*\]\s*$", line):
              in_project = False

            # Preserve original newline; avoid patterns that can consume '\n'.
            if in_project and not replaced and re.match(r'^\s*version\s*=\s*".*"\s*$', line_wo_nl):
              out.append(f'version = "{new_version}"{nl}')
              replaced = True
            else:
              out.append(line)

          if not replaced:
            raise SystemExit("Failed to update [project].version in pyproject.toml")

          p.write_text("".join(out), encoding="utf-8")
          print(f"Set version = {new_version}")
          PY

      - name: Inject build info into package (wheel will include this)
        shell: bash
        run: |
          set -euo pipefail
          cat > src/slimgest/_build_info.py <<'PY'
          # Generated at build time by CI. Do not edit.
          version = "${{ steps.meta.outputs.build_version }}"
          build_date_utc = "${{ steps.meta.outputs.date_utc }}"
          build_timestamp_utc = "${{ steps.meta.outputs.timestamp_utc }}"
          git_sha = "${{ steps.meta.outputs.sha_short }}"
          git_branch = "${{ steps.meta.outputs.branch }}"
          git_ref = "${{ steps.meta.outputs.ref }}"
          PY

      - name: Build wheel
        run: |
          python -m build --wheel

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimgest-wheel-${{ steps.meta.outputs.build_version }}
          path: dist/*.whl
          if-no-files-found: error

      - name: Publish to TestPyPI
        if: ${{ steps.meta.outputs.publish_to == 'testpypi' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true

      - name: Publish to PyPI
        if: ${{ steps.meta.outputs.publish_to == 'pypi' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: false

