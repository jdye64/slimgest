# Util Module

Utilities for inspecting and analyzing data files.

## Commands

### `inspect-pkl`

Inspect pickle files and display an overview of their contents.

**Usage:**

```bash
# Basic inspection
slimgest util inspect-pkl /path/to/file.pkl

# With custom max depth for nested structures
slimgest util inspect-pkl /path/to/file.pkl --max-depth 5

# Show raw representation
slimgest util inspect-pkl /path/to/file.pkl --show-raw
```

**Features:**

- Displays file size and root type
- Recursively analyzes nested data structures (dicts, lists, objects)
- Shows keys, lengths, and sample values
- Rich formatted output with tables and trees
- Configurable analysis depth

**Example:**

```bash
slimgest util inspect-pkl /datasets/nv-ingest/results_a100.pkl
```

This will display:
- Basic file information (size, root type)
- Structure analysis with a tree view
- Summary table for dictionaries showing keys, types, and sample values

### `cleanup-stages`

Delete stage output files from a directory. This command removes all output files generated by a specified stage and all subsequent stages.

**Usage:**

```bash
# Delete stage5 and later (with confirmation)
slimgest util cleanup-stages ./outputs/simple stage5

# Delete stage6 and later without confirmation
slimgest util cleanup-stages ./outputs/simple 6 --force

# Dry run to see what would be deleted
slimgest util cleanup-stages ./outputs/simple stage5 --dry-run
```

**Stage Output Patterns:**

- **Stage 2**: `.page_elements_v3.json`, `.page_element_detections.png`
- **Stage 3**: `.graphic_elements_v1.json`
- **Stage 4**: `.table_structure_v1.json`
- **Stage 5**: `.nemotron_ocr_v1.json`
- **Stage 6**: `.embeddings.pt`, `.embedder-input.txt`
- **Stage 7+**: No local files (VDB upload, recall analysis)

**Features:**

- Scans directory recursively for stage output files
- Shows summary table with file counts and sizes
- Supports dry-run mode to preview deletions
- Requires confirmation unless `--force` is used
- Flexible stage specification (e.g., "stage5", "5", "Stage 5")

**Examples:**

```bash
# Preview what would be deleted
slimgest util cleanup-stages ./outputs/simple stage5 --dry-run

# Delete embeddings and everything after (stage 6+)
slimgest util cleanup-stages ./outputs/simple stage6 --force

# Delete all stages from stage 2 onwards
slimgest util cleanup-stages ./data/pages stage2
```

**Use Cases:**

- Free up disk space by removing intermediate results
- Re-run stages from a specific point in the pipeline
- Clean up after testing or development
- Remove embeddings before re-generating with different settings

### `gather-skipped`

Gather all files associated with skipped stage6 images into a zip file for offline analysis.

**Usage:**

```bash
# Auto-detect stage6_skipped file and create zip
slimgest util gather-skipped ./outputs/simple

# Specify custom output location
slimgest util gather-skipped ./outputs/simple -o ~/skipped_analysis.zip

# Use specific skipped file
slimgest util gather-skipped ./outputs/simple --skipped-file ./outputs/simple/stage6_skipped_20260131_120000.csv

# Include missing files in manifest
slimgest util gather-skipped ./outputs/simple --include-missing
```

**Associated Files Gathered:**

For each skipped image, the command collects:
- Original image (`.png`)
- Page element detections overlay (`.page_element_detections.png`)
- PDFium extracted text (`.pdfium_text.txt`)
- Stage 2 output (`.page_elements_v3.json`)
- Stage 3 output (`.graphic_elements_v1.json`)
- Stage 4 output (`.table_structure_v1.json`)
- Stage 5 output (`.nemotron_ocr_v1.json`)
- Embedder input (`.embedder-input.txt`)
- Original `stage6_skipped.csv` file

**Features:**

- Auto-detects the most recent `stage6_skipped_*.csv` file
- Organized directory structure in the zip (one folder per image)
- Includes a detailed README with archive information
- Shows summary of files collected and compression stats
- Reports missing files (if any)
- Progress bars for long operations

**Zip File Structure:**

```
skipped_files_<timestamp>.zip
├── README.txt                          # Archive information
├── manifest/
│   └── stage6_skipped.csv             # Original skipped file list
└── <image_name>/
    ├── img/                           # Original image
    ├── img_overlay/                   # Detection visualization
    ├── pdfium_text/                   # Extracted PDF text
    ├── stage2/                        # Page elements detection
    ├── stage3/                        # Graphic elements detection
    ├── stage4/                        # Table structure detection
    ├── stage5/                        # Nemotron OCR results
    └── embedder_input/                # Embedding input text
```

**Use Cases:**

- Download problematic files for offline debugging
- Share examples of CUDA OOM errors with team members
- Analyze patterns in skipped images
- Archive failed processing attempts for future reference

### `find-skipped-embeddings-in-query`

Find skipped embeddings that appear in query ground truth. This identifies critical pages that were skipped during stage 6 embedding but are needed for recall evaluation.

**Usage:**

```bash
# Auto-detect skipped file
slimgest util find-skipped-embeddings-in-query ./outputs/simple --query-file bo767_query_gt.csv

# Specify custom skipped file
slimgest util find-skipped-embeddings-in-query ./outputs/simple \
    --query-file queries.csv \
    --skipped-file ./outputs/simple/stage6_skipped_20260131_120000.csv
```

**What it does:**

1. Reads the `stage6_skipped_*.csv` file (auto-detected or specified)
2. Extracts PDF page identifiers from skipped image paths (e.g., `1102434_page0019.png` → `1102434_20`)
3. Reads the query ground truth CSV file
4. Finds pages that are both skipped AND referenced in queries
5. Reports detailed statistics and recommendations

**Features:**

- Auto-detects most recent `stage6_skipped_*.csv` file
- Parses image filenames to extract PDF and page numbers
- Matches against query ground truth
- Shows detailed table of affected pages
- Counts queries per affected page
- Breaks down skip reasons (e.g., CUDA OOM)
- Provides actionable recommendations

**Output includes:**

- Table of skipped pages found in queries
- Number of queries affected per page
- Skip reason for each page
- Overall statistics (percentage of queries affected)
- Breakdown by skip reason
- Recommendations for resolution

**Example Output:**

```
⚠ Found 5 skipped pages in query ground truth!

┏━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ PDF_Page    ┃ Image Path            ┃ Skip Reason     ┃ Queries Affected ┃
┡━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ 1102434_20  │ 1102434_page0019.png  │ cuda_oom        │ 2                │
│ 1057021_129 │ 1057021_page0128.png  │ cuda_oom        │ 1                │
└─────────────┴───────────────────────┴─────────────────┴──────────────────┘

═══ Summary ═══
Total skipped pages: 25
Total query pages: 892
Skipped pages in queries: 5
Queries affected: 8 out of 993
Percentage of queries affected: 0.8%

Skip Reasons:
  - cuda_oom: 5 pages

⚠ Recommendations:
1. Re-process these pages with more available GPU memory
2. Consider using smaller batch sizes for these pages
3. Temporarily reduce image resolution for problematic pages
4. Exclude affected queries from recall evaluation until resolved
```

**Use Cases:**

- Validate recall evaluation completeness
- Identify critical pages that need re-processing
- Understand impact of skipped pages on evaluation
- Prioritize which pages to re-process first
- Debug recall scores that seem unexpectedly low
